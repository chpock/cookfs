tcltest::test cookfsPages-1.1 "Create empty pages as read-write" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set pg [cookfs::pages $file]
} -cleanup {
    $pg delete
    catch {file delete -force $file}
} -returnCodes {ok} -match glob -result {::cookfs::pageshandle*}

tcltest::test cookfsPages-1.2 "Create pages as read-write with existing prefix" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set fh [open $file w]
    puts -nonewline $fh "PrefixTest01"
    close $fh
    set pg [cookfs::pages $file]
    $pg delete
    set fh [open $file r]
    set fc [read $fh 12]
} -cleanup {
    close $fh
    catch {file delete -force $file}
} -returnCodes {ok} -match glob -result {PrefixTest01}

tcltest::test cookfsPages-1.3 "Create pages as read-write with existing prefix and add page" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set fh [open $file w]
    puts -nonewline $fh "PrefixTest01"
    close $fh
    set pg [cookfs::pages $file]
    $pg add "Test"
    $pg delete
    set fh [open $file r]
    set fc [read $fh 12]
} -cleanup {
    close $fh
    catch {file delete -force $file}
} -returnCodes {ok} -match glob -result {PrefixTest01}

tcltest::test cookfsPages-1.4 "Create empty pages as read-only" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set pg [cookfs::pages -readonly $file]
} -cleanup {
    catch {file delete -force $file}
} -returnCodes {error} -match glob -result {Unable to create Cookfs object}

tcltest::test cookfsPages-2.1 "Test correctness of pages after write" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set pg [cookfs::pages -compression zlib $file]
    set pages {
        {string repeat TEST 1}
        {string repeat TEST 1024}
        {string repeat TEST 16383}
        {string repeat TEST 16385}
    }
    foreach p $pages {
        lappend idxlist [$pg add [eval $p]]
    }
    $pg delete

    set pg [cookfs::pages -readonly $file]
    foreach p $pages idx $idxlist {
        if {![string equal [$pg get $idx] [eval $p]]} {
            error "Page $idx contains invalid data"
        }
    }
    $pg delete
} -cleanup {
    catch {file delete -force $file}
} -returnCodes {ok}

tcltest::test cookfsPages-2.2 "Test read-only error for adding a page" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set pg [cookfs::pages -compression zlib $file]
    set i0 [$pg add T1]
    $pg delete

    set pg [cookfs::pages -readonly $file]
    $pg add T2
} -cleanup {
    $pg delete
    catch {file delete -force $file}
} -returnCodes {error} -result {Unable to add page}

tcltest::test cookfsPages-3.1 "Test appended file handling" -setup {
    set file [tcltest::makeFile {} pages.cfs]
    set file2 [tcltest::makeFile {} pages2.cfs]
} -body {
    set pg [cookfs::pages -compression zlib $file]
    set i0 [$pg add [string repeat "TEST" 64]]
    $pg index "Index1"
    $pg delete
    file stat $file s0

    set pg [cookfs::pages -readonly $file]
    $pg aside $file2
    set i1 [$pg add [string repeat "TEST" 96]]
    $pg index "Index2"
    $pg delete
    file stat $file s1

    if {$s1(size) != $s0(size)} {
        error "Sizes of $file differ"
    }

    set pg [cookfs::pages -readonly $file]
    $pg aside $file2

    if {[$pg index] != "Index2"} {
        error "Index error"
    }

    if {[$pg get $i0] != [string repeat "TEST" 64]} {
        error "Page i0 failed"
    }

    if {[$pg get $i1] != [string repeat "TEST" 96]} {
        error "Page i1 failed"
    }
} -cleanup {
    $pg delete
    catch {file delete -force $file}
    catch {file delete -force $file2}
} -returnCodes {ok}

tcltest::test cookfsPages-3.2 "Test appended file handling - adding same page to new archive" -setup {
    set file [tcltest::makeFile {} pages.cfs]
    set file2 [tcltest::makeFile {} pages2.cfs]
} -body {
    set pg [cookfs::pages -compression zlib $file]
    set i0 [$pg add [string repeat "TEST" 64]]
    $pg index "Index1"
    $pg delete
    file stat $file s0

    set pg [cookfs::pages -readonly $file]
    $pg aside $file2
    set i1 [$pg add [string repeat "TEST" 96]]
    set i2 [$pg add [string repeat "TEST" 64]]
    set i3 [$pg add [string repeat "TEST" 96]]
    set i4 [$pg add [string repeat "TEST" 80]]
    $pg index "Index2"
    $pg delete
    file stat $file s1

    if {$s1(size) != $s0(size)} {
        error "Sizes of $file differ"
    }

    set pg [cookfs::pages -readonly $file]
    $pg aside $file2

    if {[$pg index] != "Index2"} {
        error "Index error"
    }

    if {[$pg get $i0] != [string repeat "TEST" 64]} {
        error "Page i0 failed"
    }

    if {[$pg get $i1] != [string repeat "TEST" 96]} {
        error "Page i1 failed"
    }

    if {$i1 != $i3} {
        error "Page i3 was not matched correctly"
    }

    if {$i2 != $i0} {
        error "Page i2 was created again"
    }

    if {($i0 == $i4) || ($i1 == $i4) || ($i2 == $i4) || ($i3 == $i4)} {
        error "Page i4 was reused"
    }
} -cleanup {
    $pg delete
    catch {file delete -force $file}
    catch {file delete -force $file2}
} -returnCodes {ok}

tcltest::test cookfsPages-4.1 "Test specifying -endoffset" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set pg [cookfs::pages -compression zlib $file]
    set i0 [$pg add [string repeat "TEST" 64]]
    $pg index "Index1"
    $pg delete

    if {[catch {
	set pg [cookfs::pages -readonly $file]
    }]} {
	error ""
    }
    $pg delete

    set size [file size $file]
    set fh [open $file a]
    fconfigure $fh -translation binary
    puts -nonewline $fh ".FILE.SUFFIX."
    close $fh

    if {![catch {
	set pg [cookfs::pages -readonly $file]
    }]} {
	error "Opening a file with data added did not throw an error"
    }

    if {[catch {
	set pg [cookfs::pages -readonly -endoffset $size $file]
    } err]} {
	error "Opening a file with data added and specifying -endoffsert threw an error: $err"
    }

    if {[$pg get $i0] != [string repeat "TEST" 64]} {
	error "Reading page $i0 failed"
    }
} -cleanup {
    $pg delete
    catch {file delete -force $file}
} -returnCodes {ok}

tcltest::test cookfsPages-5.1 "Test multiple compression algorithms" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set pg [cookfs::pages -compression none $file]
    set i0 [$pg add [string repeat "TESTNONE" 2048]]
    $pg index "Index0"
    $pg delete

    set fs0 [file size $file]

    set pg [cookfs::pages -compression zlib $file]
    set i1 [$pg add [string repeat "TESTZLIB" 2048]]
    set i [$pg index]
    if {![string equal $i "Index0"]} {
	error "Incorrect index-$i ([string length $i])"
    }
    $pg index "Index1-$i"
    $pg delete

    set fs1 [file size $file]
    if {($fs1 - $fs0) > 1024} {
	error "Next page not compressed using zlib"
    }

    if {[catch {
	set pg [cookfs::pages -readonly $file]
    }]} {
	error "Unable to read pages after changing compression"
    }

    set i [$pg index]
    if {![string equal $i "Index1-Index0"]} {
	error "Incorrect index-$i ([string length $i])"
    }

    if {![string equal [$pg get $i0] [string repeat "TESTNONE" 2048]]} {
	error "Incorrect uncompressed page contents"
    }

    if {![string equal [$pg get $i1] [string repeat "TESTZLIB" 2048]]} {
	error "Incorrect uncompressed page contents"
    }
} -cleanup {
    catch {file delete -force $file}
} -returnCodes {ok}

