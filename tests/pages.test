tcltest::test cookfsPages-1.1 "Create empty pages as read-write" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set pg [cookfs::pages $file]
} -cleanup {
    $pg delete
} -returnCodes {ok} -match glob -result {::cookfs::pageshandle*}

tcltest::test cookfsPages-1.2 "Create pages as read-write with existing prefix" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set fh [open $file w]
    puts -nonewline $fh "PrefixTest01"
    close $fh
    set pg [cookfs::pages $file]
    $pg delete
    set fh [open $file r]
    set fc [read $fh 12]
} -cleanup {
    close $fh
} -returnCodes {ok} -match glob -result {PrefixTest01}

tcltest::test cookfsPages-1.3 "Create empty pages as read-only" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set pg [cookfs::pages -readonly $file]
} -cleanup {
} -returnCodes {error} -match glob -result {Unable to create Cookfs object}

tcltest::test cookfsPages-2.1 "Test correctness of pages after write" -setup {
    set file [tcltest::makeFile {} pages.cfs]
} -body {
    set pg [cookfs::pages -compression zlib $file]
    set pages {
        {string repeat TEST 1}
        {string repeat TEST 1024}
        {string repeat TEST 16383}
        {string repeat TEST 16385}
    }
    foreach p $pages {
        lappend idxlist [$pg add [eval $p]]
    }
    $pg delete

    set pg [cookfs::pages -readonly $file]
    foreach p $pages idx $idxlist {
        if {![string equal [$pg get $idx] [eval $p]]} {
            error "Page $idx contains invalid data"
        }
    }
    $pg delete
} -cleanup {
} -returnCodes {ok}

tcltest::test cookfsPages-3.1 "Test appended file handling" -setup {
    set file [tcltest::makeFile {} pages.cfs]
    set file2 [tcltest::makeFile {} pages2.cfs]
} -body {
    set pg [cookfs::pages -compression zlib $file]
    set i0 [$pg add [string repeat "TEST"] 64]
    $pg delete

    set pg [cookfs::pages -readonly $file]
    set i0 [$pg add [string repeat "TEST"] 96]
    $pg delete
} -cleanup {
} -returnCodes {ok}

